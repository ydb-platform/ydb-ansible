#jinja2: trim_blocks:False
[Unit]
Description=YDB dynamic node / {{ ydb_dbname }} / {{ item.instance }}
After=network-online.target rc-local.service
Wants=network-online.target
StartLimitInterval=10
StartLimitBurst=15

[Service]
Restart=always
RestartSec=1
User=ydb
UMask=077
PermissionsStartOnly=true
SyslogIdentifier=ydbd
SyslogFacility=daemon
SyslogLevel=err
WorkingDirectory={{ ydb_dir }}/audit/{{ ydb_dbname }}-{{ item.instance }}
Environment=LD_LIBRARY_PATH={{ ydb_dir }}/lib
ExecStart={{ ydb_dir }}/bin/ydbd server --tenant /{{ ydb_domain }}/{{ ydb_dbname }} --tcp \
    --yaml-config  {{ ydb_dir }}/cfg/ydbd-dynamic.yaml  \
{%- if 'offset' in item %}
    --grpcs-port {{ 2136 + item.offset }}  --ic-port {{ 19002 + item.offset }} --mon-port {{ 8766 + item.offset }}  \
{%- else %}
    --grpcs-port 2136 --ic-port 19002 --mon-port 8766  \
{%- endif %}
{%- for brk in ydb_brokers %}
    --node-broker grpcs://{{ brk }}:2135 \
{%- endfor %}
{%- if ydb_node_dc is defined %}
    --data-center {{ ydb_node_dc }} --rack {{ ydb_node_rack }} --body {{ ydb_node_body }} \
{%- endif %}
    --ca {{ ydb_dir }}/certs/ca.crt --grpc-ca {{ ydb_dir }}/certs/ca.crt \
    --mon-cert {{ ydb_dir }}/certs/web.pem
LimitNOFILE=65536
LimitCORE=0
LimitMEMLOCK=32212254720
{%- if 'affinity' in item %}
CPUAffinity={{ item.affinity }}
{%- endif %}

[Install]
WantedBy=multi-user.target
